name: APPDOME_CI_EXAMPLE
# Controls when the workflow will run
on:
 # Triggers the workflow on push or pull request events but only for the "main" branch
 push:
  branches: [ "main" ]
 pull_request:
  branches: [ "main" ]
 # Allows you to run this workflow manually from the Actions tab
 workflow_dispatch:
# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
 # This workflow contains a single job called "build"
 a:
  outputs:
      # Map the step outputs to job outputs
    my_secure_app: ${{steps.secure_app_file.outputs.my_secure_app}}
 # The type of runner that the job will run on
  runs-on: ubuntu-latest
 # Steps represent a sequence of tasks that will be executed as part of the job
  steps:
 # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
   - uses: actions/checkout@v3
   - name: Appdome build-2secure
     id: appdome-build
     uses: Appdome/github_build-2secure@1.0
     with:
        APP_FILE: "./TimeCard.apk"
        FUSION_SET_ID: "d5079cb0-582a-11ed-8316-eb2303a43a47"
        SIGN_OPTIONS: "PRIVATE_SIGNING"
        APPDOME_API_TOKEN: ${{secrets.APPDOME_API_KEY}}
        SIGN_FINGERPRINT: ${{secrets.APPDOME_SIGN_FINGERPRINT}}
   - name: Find secure app file
     id: secure_app_file
     run: |
        FILE=$(find ./output/ -type f -name "Appdome_secured_app.*" -exec basename {} \;)
        echo "my_secure_app=$FILE" >> $GITHUB_OUTPUT
     shell: bash
   - name: List files in output directory
     run: echo $my_secure_app
     shell: bash
 b:
  runs-on: ubuntu-latest
  needs: a
 # Steps represent a sequence of tasks that will be executed as part of the job
  steps:
#    - name: Clean appdome directory
#      run: sudo rm -rf ./appdome/*
   - uses: actions/checkout@v3
   - name: Appdome build-2secure
     uses: Appdome/github_build-2secure@1.0
     with:
        APP_FILE: ${{ needs.a.outputs.my_secure_app }}
        FUSION_SET_ID: "d5079cb0-582a-11ed-8316-eb2303a43a47"
        SIGN_OPTIONS: "PRIVATE_SIGNING"
        APPDOME_API_TOKEN: ${{secrets.APPDOME_API_KEY}}
        SIGN_FINGERPRINT: ${{secrets.APPDOME_SIGN_FINGERPRINT}}
